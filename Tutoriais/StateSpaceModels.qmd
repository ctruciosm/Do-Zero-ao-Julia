---
title: "Séries Temporais Estruturais com StateSpaceModels.jl"
description: |
  Vá além do ARIMA. Aprenda a usar Modelos de Espaço de Estados para decompor séries temporais em tendência e sazonalidade, e fazer previsões robustas usando o Filtro de Kalman em Julia.
categories:
  - Time Series
  - Forecasting
  - Estatística
author:
  - name: Caio Frare
    affiliation: "Universidade Estadual de Campinas"
    url: https://github.com/caiofrare
  - name: Carlos Trucíos
    affiliation: "Universidade Estadual de Campinas"
    url: https://ctruciosm.github.io
    orcid: 0000-0001-8746-8877
date: "2025-12-02"
image: imagens/series0.png
lang: pt
format:
  html:
    toc: true
    toc-depth: 3
    self-contained: false
engine: knitr
draft: true
---

## Introdução

::: justify
Na análise de séries temporais, muitas vezes queremos mais do que apenas prever o próximo valor. Queremos entender **o que** compõe a série. A tendência está subindo? O padrão sazonal é estável? Existe um ciclo de longo prazo?

Modelos clássicos como o ARIMA focam na correlação entre valores passados. Já os **Modelos de Espaço de Estados (State Space Models)** focam na estrutura latente. Eles assumem que o que observamos é o resultado de componentes não observáveis (estados) que evoluem no tempo.

Em Julia, o pacote `StateSpaceModels.jl` fornece uma interface moderna e de alta performance para esses modelos. Ele utiliza o poderoso **Filtro de Kalman** para estimar componentes e realizar previsões.

Neste tutorial, vamos modelar o famoso dataset *AirPassengers* (número mensal de passageiros de linhas aéreas internacionais) para aprender a:
1.  Definir um modelo estrutural (Tendência + Sazonalidade).
2.  Ajustar os parâmetros via Máxima Verossimilhança.
3.  Decompor a série em seus componentes.
4.  Realizar previsões para o futuro.
:::

## Instalação

::: justify
Precisaremos do pacote de modelagem, além de ferramentas para carregar dados (`CSV`, `DataFrames`) e plotar gráficos (`Plots`).
:::

```{julia}
using Pkg
Pkg.add([
    "StateSpaceModels", 
    "CSV", 
    "DataFrames", 
    "HTTP",         
    "Plots"
])
```

## Carregando e Preparando os Dados

::: justify 
Vamos baixar o dataset diretamente da web. Como a variância do número de passageiros aumenta com o tempo (heterocedasticidade), aplicaremos uma transformação logarítmica. Isso estabiliza a variância e torna a tendência mais linear, o que ajuda o modelo. 
:::

```{julia}
using StateSpaceModels
using CSV
using DataFrames
using HTTP
using Plots

# URL do dataset AirPassengers
url = "https://raw.githubusercontent.com/jbrownlee/Datasets/master/airline-passengers.csv"

# Usamos HTTP.get para baixar o conteúdo e IOBuffer para ler como se fosse arquivo
resp = HTTP.get(url)
df = CSV.read(IOBuffer(resp.body), DataFrame)

# Acessando a coluna de dados e aplicando Log
# A coluna geralmente se chama "Passengers"
y_raw = Float64.(df[:, 2])
y = log.(y_raw)

# Visualização inicial
Plots.plot(y, label="Log(Passageiros)", title="Série Temporal: AirPassengers (Log)", 
     xlabel="Tempo (Meses)", ylabel="Log(Qtd)")
```

![Gráfico series](imagens/series.png)

## O Modelo Estrutural Básico

::: justify
O StateSpaceModels.jl facilita muito a criação de modelos estruturais. Não precisamos escrever as matrizes do Filtro de Kalman manualmente.
Podemos usar a estrutura BasicStructural, que define a série $y_t$ como:

$$y_t = \mu_t + \gamma_t + \varepsilon_t$$
Onde:

-   $\mu_t$: É a Tendência Local (nível + inclinação).

-   $\gamma_t$: É a Sazonalidade (padrão que se repete).

-   $\varepsilon_t$: É o Ruído (erro de medição).

Como nossos dados são mensais, a sazonalidade é $s = 12$.
:::

```{julia}
# Definindo o modelo Estrutural Básico
# s = 12 indica sazonalidade de 12 períodos (anual/mensal)
model = BasicStructural(y, 12)

# Ajustando o modelo (encontrando as variâncias ótimas dos componentes)
fit!(model)

# Exibindo resumo do ajuste
print_results(model)
```

## Forecasting (Previsão)

::: justify
Com o modelo ajustado, prever o futuro é simples. Vamos projetar os próximos 24 meses (2 anos). O pacote calcula não apenas a previsão pontual, mas também os intervalos de confiança baseados na incerteza dos estados. 
:::

```{julia}
# Realiza a previsão para 24 passos à frente
steps = 24
forec = forecast(model, steps)

# Visualizando a previsão
# O gráfico automático do pacote já mostra dados históricos + previsão + intervalo
plot(model, forec, title="Previsão de Passageiros (24 meses)")
```

![Gráfico series2](imagens/series2.png)

::: justify
O gráfico acima mostra a linha azul (dados observados) e a linha laranja (previsão), com a sombra indicando o intervalo de confiança. Note como o modelo capturou perfeitamente os picos de verão e as quedas de inverno. 
:::

## O "Pulo do Gato": Decomposição

::: justify
A grande vantagem deste tipo de modelo sobre o ARIMA ou Redes Neurais é a interpretabilidade. Podemos pedir ao modelo para nos mostrar separadamente o que ele entende como "Tendência" e o que é "Sazonalidade". Isso é crucial para tomada de decisão: se as vendas caíram, foi culpa da sazonalidade (esperado) ou a tendência do negócio que está piorando (preocupante)? 
:::

```{julia}
# Obtendo os estados suavizados (smoothed states)
# Isso retorna a melhor estimativa dos componentes para cada ponto do passado
states = get_smoothed_state(model)

# O BasicStructural retorna os estados na ordem: [Tendência, Inclinação, Sazonalidade...]
trend = states[:, 1]
seasonal = states[:, 3] # O índice pode variar, mas geralmente o 3º inicia a sazonalidade

# Plotando a decomposição
p1 = plot(y, label="Original", title="Série Original")
p2 = plot(trend, label="Tendência", color=:red, title="Componente de Tendência")
p3 = plot(seasonal, label="Sazonalidade", color=:green, title="Componente Sazonal")

plot(p1, p2, p3, layout=(3,1), size=(800, 800))
```

![Gráfico series3](imagens/series3.png)

::: justify 
Na figura acima:

-   Original: A série completa.

-   Tendência: Note como ela é suave e remove as oscilações anuais, mostrando o crescimento real do tráfego aéreo.

-   Sazonalidade: O padrão cíclico isolado, oscilando em torno de zero. :::

## Diagnóstico do Modelo (Análise de Resíduos)

::: justify
Como saber se nosso modelo é bom? Na estatística, analisamos os **resíduos** (a diferença entre o que o modelo previu e o que realmente aconteceu).
Se o modelo capturou bem a estrutura dos dados (tendência e sazonalidade), os resíduos devem se comportar como **Ruído Branco**:
1.  Média próxima de zero.
2.  Variância constante.
3.  Sem correlação temporal (aleatórios).
:::

```{julia}
# Obtendo as inovações (resíduos de predição um passo à frente)
residuos = get_innovations(model)

# Visualizando
# 1. Gráfico no tempo (deve parecer aleatório)
p1 = plot(residuos, title="Resíduos no Tempo", legend=false, color=:gray)
hline!(p1, [0], color=:red, linestyle=:dash)

# 2. Histograma (deve parecer uma Normal centrada no zero)
p2 = histogram(residuos, title="Distribuição dos Resíduos", legend=false, normalize=true)

# Plotando juntos
plot(p1, p2, layout=(2,1), size=(800, 600))
```

![Gráfico series4](imagens/series4.png)

::: justify 
Análise de Diagnóstico: Os gráficos acima validam nosso modelo. Na parte superior, vemos os resíduos ao longo do tempo; a oscilação violenta no início (esquerda) representa o período em que o modelo estava "aprendendo" os estados iniciais. 

Após esse período, os resíduos se estabilizam em torno da linha vermelha (zero), sem padrões óbvios, o que indica que capturamos com sucesso a tendência e a sazonalidade. O histograma reforça isso, mostrando uma alta concentração de erros próximos a zero. 
:::

## Conclusão

::: justify
O StateSpaceModels.jl é uma ferramenta poderosa que traz a robustez da engenharia de controle (Filtro de Kalman) para a Ciência de Dados. Neste tutorial, vimos que modelar uma série temporal não precisa ser uma "caixa-preta". Ao decompor o problema em Tendência + Sazonalidade, ganhamos:

-   Previsões Precisas: Que respeitam a estrutura dos dados.

-   Interpretabilidade: Sabemos exatamente o impacto da sazonalidade.

-   Flexibilidade: Podemos lidar com dados faltantes (o Kalman Filter lida nativamente com missing) e simular cenários.

Para quem estuda estatística, dominar Espaço de Estados é um diferencial técnico importante, abrindo portas para modelos ainda mais complexos como Modelos Dinâmicos Bayesianos. 
:::

::: callout-note
Ferramentas de IA foram utilizadas para correção ortográfica e aprimoramento do texto. 
:::










